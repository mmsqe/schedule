<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Maker</title>
    <!-- LZ-String compression for shorter URLs -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Main Calendar Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #fff;
            padding: 15px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .day-selector {
            display: flex;
            gap: 5px;
        }

        .day-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .day-btn:hover {
            border-color: #3498db;
            color: #3498db;
        }

        .day-btn.active {
            background: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .calendar-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: flex;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            min-height: 1020px;
        }

        .time-column {
            width: 60px;
            flex-shrink: 0;
            background: #fafafa;
            border-right: 1px solid #e8e8e8;
        }

        .time-label {
            height: 60px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 0;
            font-size: 0.75rem;
            color: #888;
            font-weight: 500;
            position: relative;
            top: -8px;
        }

        .days-container {
            flex: 1;
            display: flex;
        }

        .day-column {
            flex: 1;
            border-right: 1px solid #e8e8e8;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            background: #fafafa;
            border-bottom: 1px solid #e8e8e8;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .day-header.today {
            color: #3498db;
            background: #e8f4fc;
        }

        .day-events {
            position: relative;
            height: 1020px;
        }

        .hour-slot {
            height: 60px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
        }

        .hour-slot:hover {
            background: rgba(52, 152, 219, 0.08);
        }

        /* Event Blocks */
        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            overflow: hidden;
            border-left: 4px solid;
            z-index: 2;
        }

        .event-block:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .event-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: inherit;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .event-location {
            font-size: 0.75rem;
            opacity: 0.85;
            margin-bottom: 2px;
        }

        .event-time {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .event-block.small .event-location {
            display: none;
        }

        .event-block.tiny .event-time,
        .event-block.tiny .event-location {
            display: none;
        }

        .event-block.tiny .event-title {
            font-size: 0.75rem;
        }

        /* Right Sidebar */
        .sidebar {
            width: 70px;
            background: #fff;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            gap: 15px;
        }

        .sidebar-btn {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            border: none;
            background: #f5f5f5;
            color: #666;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            font-size: 0.65rem;
        }

        .sidebar-btn:hover {
            background: #e8f4fc;
            color: #3498db;
        }

        .sidebar-btn svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-btn.primary {
            background: #3498db;
            color: #fff;
        }

        .sidebar-btn.primary:hover {
            background: #2980b9;
        }

        .sidebar-divider {
            width: 40px;
            height: 1px;
            background: #e0e0e0;
            margin: 5px 0;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: translateY(-20px);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .color-picker-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        .modal-footer {
            padding: 15px 25px 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: #3498db;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        .btn-danger {
            background: #fff;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .btn-danger:hover {
            background: #e74c3c;
            color: #fff;
        }

        /* Settings Modal */
        .settings-group {
            margin-bottom: 25px;
        }

        .settings-group h3 {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
        }

        .settings-row label {
            color: #333;
            font-weight: 500;
        }

        /* Export Buttons */
        .export-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-row .btn {
            flex: 1;
            min-width: 100px;
        }

        /* Empty State */
        .empty-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #bbb;
            pointer-events: none;
        }

        .empty-hint svg {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-hint p {
            font-size: 0.9rem;
        }

        /* View Mode Toggle */
        .view-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 3px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: #fff;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .day-column {
                min-width: 100px;
            }
            .days-container {
                overflow-x: auto;
            }
        }

        @media (max-width: 600px) {
            .app-container {
                flex-direction: column;
            }

            .main-area {
                padding-bottom: 70px;
            }

            .header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .header h1 {
                font-size: 1.3rem;
                text-align: center;
            }

            .view-toggle {
                justify-content: center;
            }

            .day-selector {
                justify-content: center;
                flex-wrap: wrap;
            }

            .day-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            /* Bottom navigation bar */
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 65px;
                flex-direction: row;
                justify-content: space-around;
                padding: 8px 10px;
                border-left: none;
                border-top: 1px solid #e0e0e0;
                background: #fff;
                z-index: 100;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }

            .sidebar-divider {
                display: none;
            }

            .sidebar-btn {
                width: 50px;
                height: 48px;
                font-size: 0.6rem;
            }

            .sidebar-btn svg {
                width: 18px;
                height: 18px;
            }

            .sidebar-btn.primary {
                width: 56px;
            }

            /* Calendar adjustments */
            .calendar-wrapper {
                padding: 10px;
            }

            .calendar-grid {
                min-height: auto;
                border-radius: 8px;
            }

            .time-column {
                width: 45px;
            }

            .time-label {
                font-size: 0.65rem;
            }

            .day-column {
                min-width: 80px;
            }

            .day-header {
                padding: 8px 5px;
                font-size: 0.85rem;
            }

            .event-block {
                padding: 4px 6px;
                border-left-width: 3px;
            }

            .event-title {
                font-size: 0.75rem;
            }

            .event-location,
            .event-time {
                font-size: 0.65rem;
            }

            /* Modal full screen on mobile */
            .modal {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }

            .modal-body {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                border-top: 1px solid #e8e8e8;
                flex-wrap: wrap;
                gap: 8px;
            }

            .modal-footer .btn {
                padding: 14px 20px;
            }

            .form-group input,
            .form-group select {
                padding: 14px 15px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .color-option {
                width: 40px;
                height: 40px;
            }

            /* Share modal adjustments */
            #shareModal .modal {
                height: auto;
                max-height: 90%;
                margin: 20px;
                border-radius: 16px;
            }

            #settingsModal .modal,
            #exportModal .modal {
                height: auto;
                max-height: 90%;
                margin: 20px;
                border-radius: 16px;
            }
        }

        /* Extra small devices */
        @media (max-width: 380px) {
            .sidebar-btn {
                width: 44px;
                height: 44px;
            }

            .sidebar-btn span {
                display: none;
            }

            .day-btn {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-area">
            <div class="header">
                <h1>Schedule Maker</h1>
                <div class="view-toggle">
                    <button class="active" data-view="weekly">Weekly</button>
                    <button data-view="daily">Daily</button>
                </div>
                <div class="day-selector" id="daySelectorDaily" style="display: none;">
                    <button class="day-btn" data-day="monday">Mon</button>
                    <button class="day-btn" data-day="tuesday">Tue</button>
                    <button class="day-btn" data-day="wednesday">Wed</button>
                    <button class="day-btn" data-day="thursday">Thu</button>
                    <button class="day-btn" data-day="friday">Fri</button>
                    <button class="day-btn" data-day="saturday">Sat</button>
                    <button class="day-btn" data-day="sunday">Sun</button>
                </div>
            </div>

            <div class="calendar-wrapper">
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div class="sidebar">
            <button class="sidebar-btn primary" id="addBtn" title="Add Event">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Add</span>
            </button>

            <div class="sidebar-divider"></div>

            <button class="sidebar-btn" id="settingsBtn" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span>Settings</span>
            </button>

            <button class="sidebar-btn" id="shareBtn" title="Share">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
                <span>Share</span>
            </button>

            <button class="sidebar-btn" id="exportBtn" title="Export">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Export</span>
            </button>

            <button class="sidebar-btn" id="resetBtn" title="Reset">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
                <span>Reset</span>
            </button>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Add Event</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Event Title</label>
                    <input type="text" id="eventTitle" placeholder="e.g., School, Basketball">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="eventLocation" placeholder="e.g., Home, ESF School">
                </div>
                <div class="form-group">
                    <label>Day</label>
                    <select id="eventDay">
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                        <option value="sunday">Sunday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <div class="time-inputs">
                        <input type="time" id="eventStart" value="09:00">
                        <input type="time" id="eventEnd" value="10:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker-grid" id="colorPicker">
                        <div class="color-option selected" data-color="#4A90A4" style="background: #4A90A4;"></div>
                        <div class="color-option" data-color="#7B68EE" style="background: #7B68EE;"></div>
                        <div class="color-option" data-color="#E57373" style="background: #E57373;"></div>
                        <div class="color-option" data-color="#81C784" style="background: #81C784;"></div>
                        <div class="color-option" data-color="#FFB74D" style="background: #FFB74D;"></div>
                        <div class="color-option" data-color="#F06292" style="background: #F06292;"></div>
                        <div class="color-option" data-color="#90A4AE" style="background: #90A4AE;"></div>
                        <div class="color-option" data-color="#9575CD" style="background: #9575CD;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteEvent" style="display: none;">Delete</button>
                <button class="btn btn-secondary" id="copyEvent" style="display: none;">Copy</button>
                <button class="btn btn-secondary" id="pasteEvent" style="display: none;">Paste</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-secondary" id="cancelEvent">Cancel</button>
                <button class="btn btn-primary" id="saveEvent">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <h3>Time Range</h3>
                    <div class="time-inputs">
                        <div>
                            <label style="font-size: 0.8rem; color: #888;">Start Hour</label>
                            <select id="startHour" style="margin-top: 5px;">
                                <option value="5">5 AM</option>
                                <option value="6">6 AM</option>
                                <option value="7" selected>7 AM</option>
                                <option value="8">8 AM</option>
                                <option value="9">9 AM</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: #888;">End Hour</label>
                            <select id="endHour" style="margin-top: 5px;">
                                <option value="18">6 PM</option>
                                <option value="19">7 PM</option>
                                <option value="20">8 PM</option>
                                <option value="21">9 PM</option>
                                <option value="22">10 PM</option>
                                <option value="23" selected>11 PM</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="settings-group">
                    <h3>Display</h3>
                    <div class="settings-row">
                        <label>Show Weekends</label>
                        <input type="checkbox" id="showWeekends" checked>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="applySettings()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Export Schedule</h2>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-row">
                    <button class="btn btn-secondary" onclick="exportSchedule('csv')">
                        CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportSchedule('json')">
                        JSON
                    </button>
                    <button class="btn btn-secondary" onclick="exportSchedule('md')">
                        Markdown
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Share Schedule</h2>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">Anyone with this link can view your schedule:</p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="shareUrl" readonly style="flex: 1; font-size: 0.85rem;">
                    <button class="btn btn-primary" onclick="copyShareUrl()">Copy</button>
                </div>
                <p id="copyStatus" style="margin-top: 10px; color: #27ae60; font-size: 0.85rem; display: none;">Link copied to clipboard!</p>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            view: 'weekly',
            currentDay: 'monday',
            startHour: 7,
            endHour: 23,
            showWeekends: true,
            selectedColor: '#4A90A4',
            editingEventId: null,
            copiedEvent: null,
            events: {
                monday: [],
                tuesday: [],
                wednesday: [],
                thursday: [],
                friday: [],
                saturday: [],
                sunday: []
            }
        };

        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayNamesShort = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // DOM Elements
        const calendarGrid = document.getElementById('calendarGrid');
        const eventModal = document.getElementById('eventModal');
        const settingsModal = document.getElementById('settingsModal');
        const exportModal = document.getElementById('exportModal');
        const shareModal = document.getElementById('shareModal');
        const viewToggleBtns = document.querySelectorAll('.view-toggle button');
        const dayBtns = document.querySelectorAll('.day-btn');
        const colorOptions = document.querySelectorAll('.color-option');

        // LocalStorage functions
        const STORAGE_KEY = 'schedulemaker_data';

        function saveState() {
            const dataToSave = {
                events: state.events,
                startHour: state.startHour,
                endHour: state.endHour,
                showWeekends: state.showWeekends
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.events) state.events = data.events;
                    if (data.startHour) state.startHour = data.startHour;
                    if (data.endHour) state.endHour = data.endHour;
                    if (typeof data.showWeekends === 'boolean') state.showWeekends = data.showWeekends;
                } catch (e) {
                    console.error('Failed to load saved data:', e);
                }
            }
        }

        // URL Sharing functions (with LZ compression for shorter URLs)
        function encodeScheduleToUrl() {
            // Only include days with events to minimize data
            const eventsToShare = {};
            days.forEach(day => {
                if (state.events[day] && state.events[day].length > 0) {
                    eventsToShare[day] = state.events[day].map(e => ({
                        t: e.title,
                        l: e.location,
                        s: e.start,
                        e: e.end,
                        c: e.color
                    }));
                }
            });

            const dataToShare = {
                e: eventsToShare,
                h: [state.startHour, state.endHour],
                w: state.showWeekends ? 1 : 0
            };
            const json = JSON.stringify(dataToShare);
            const compressed = LZString.compressToEncodedURIComponent(json);
            return window.location.origin + window.location.pathname + '?s=' + compressed;
        }

        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('s');
            if (data) {
                try {
                    const json = LZString.decompressFromEncodedURIComponent(data);
                    const parsed = JSON.parse(json);

                    // Restore events with full structure
                    if (parsed.e) {
                        days.forEach(day => {
                            if (parsed.e[day]) {
                                state.events[day] = parsed.e[day].map(e => ({
                                    id: Date.now() + Math.random(),
                                    title: e.t,
                                    location: e.l || '',
                                    start: e.s,
                                    end: e.e,
                                    color: e.c
                                }));
                            }
                        });
                    }
                    if (parsed.h) {
                        state.startHour = parsed.h[0];
                        state.endHour = parsed.h[1];
                    }
                    if (typeof parsed.w !== 'undefined') state.showWeekends = parsed.w === 1;
                    return true;
                } catch (e) {
                    console.error('Failed to load from URL:', e);
                }
            }
            return false;
        }

        // Initialize
        init();

        function init() {
            // Load from URL first (shared link), otherwise from localStorage
            if (!loadFromUrl()) {
                loadState();
            }
            renderCalendar();
            setupEventListeners();
            setActiveDay();
        }

        function setupEventListeners() {
            // View toggle
            viewToggleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    viewToggleBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.view = btn.dataset.view;
                    document.getElementById('daySelectorDaily').style.display =
                        state.view === 'daily' ? 'flex' : 'none';
                    renderCalendar();
                });
            });

            // Day selector for daily view
            dayBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    dayBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentDay = btn.dataset.day;
                    renderCalendar();
                });
            });

            // Color picker
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    colorOptions.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    state.selectedColor = option.dataset.color;
                });
            });

            // Sidebar buttons
            document.getElementById('addBtn').addEventListener('click', () => openEventModal());
            document.getElementById('settingsBtn').addEventListener('click', () => openSettingsModal());
            document.getElementById('shareBtn').addEventListener('click', () => openShareModal());
            document.getElementById('exportBtn').addEventListener('click', () => openExportModal());
            document.getElementById('resetBtn').addEventListener('click', resetSchedule);

            // Modal buttons
            document.getElementById('modalClose').addEventListener('click', closeEventModal);
            document.getElementById('cancelEvent').addEventListener('click', closeEventModal);
            document.getElementById('saveEvent').addEventListener('click', saveEvent);
            document.getElementById('deleteEvent').addEventListener('click', deleteEvent);
            document.getElementById('copyEvent').addEventListener('click', copyEvent);
            document.getElementById('pasteEvent').addEventListener('click', pasteEvent);

            // Close modals on overlay click
            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) closeEventModal();
            });
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeSettingsModal();
            });
            exportModal.addEventListener('click', (e) => {
                if (e.target === exportModal) closeExportModal();
            });
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) closeShareModal();
            });
        }

        function setActiveDay() {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
            state.currentDay = today;
            dayBtns.forEach(btn => {
                if (btn.dataset.day === today) {
                    btn.classList.add('active');
                }
            });
        }

        function renderCalendar() {
            const visibleDays = state.showWeekends ? days : days.slice(0, 5);
            const totalHours = state.endHour - state.startHour;

            // Time column
            let timeLabels = '';
            for (let h = state.startHour; h <= state.endHour; h++) {
                const hour = h % 12 || 12;
                const ampm = h >= 12 ? 'PM' : 'AM';
                timeLabels += `<div class="time-label">${hour} ${ampm}</div>`;
            }

            if (state.view === 'weekly') {
                // Weekly view
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

                let dayColumns = '';
                visibleDays.forEach((day, index) => {
                    const isToday = day === today;
                    const dayIndex = days.indexOf(day);

                    let hourSlots = '';
                    for (let h = state.startHour; h < state.endHour; h++) {
                        hourSlots += `<div class="hour-slot" data-day="${day}" data-hour="${h}"></div>`;
                    }

                    const events = renderDayEvents(day);

                    dayColumns += `
                        <div class="day-column">
                            <div class="day-header ${isToday ? 'today' : ''}">${dayNamesShort[dayIndex]}</div>
                            <div class="day-events" style="height: ${totalHours * 60}px;">
                                ${hourSlots}
                                ${events}
                            </div>
                        </div>
                    `;
                });

                calendarGrid.innerHTML = `
                    <div class="time-column">${timeLabels}</div>
                    <div class="days-container">${dayColumns}</div>
                `;
            } else {
                // Daily view
                const dayIndex = days.indexOf(state.currentDay);

                let hourSlots = '';
                for (let h = state.startHour; h < state.endHour; h++) {
                    hourSlots += `<div class="hour-slot" data-day="${state.currentDay}" data-hour="${h}"></div>`;
                }

                const events = renderDayEvents(state.currentDay);

                calendarGrid.innerHTML = `
                    <div class="time-column">${timeLabels}</div>
                    <div class="days-container">
                        <div class="day-column" style="flex: 1;">
                            <div class="day-header">${dayNames[dayIndex]}</div>
                            <div class="day-events" style="height: ${totalHours * 60}px;">
                                ${hourSlots}
                                ${events}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add click handlers for hour slots
            document.querySelectorAll('.hour-slot').forEach(slot => {
                slot.addEventListener('click', (e) => {
                    const day = slot.dataset.day;
                    const hour = parseInt(slot.dataset.hour);
                    openEventModal(null, day, hour);
                });
            });

            // Add click handlers for events
            document.querySelectorAll('.event-block').forEach(block => {
                block.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const eventId = parseInt(block.dataset.id);
                    const day = block.dataset.day;
                    const event = state.events[day].find(ev => ev.id === eventId);
                    if (event) {
                        openEventModal(event, day);
                    }
                });
            });
        }

        function renderDayEvents(day) {
            const events = state.events[day] || [];
            if (events.length === 0) return '';

            return events.map(event => {
                const { top, height } = getEventPosition(event);
                const sizeClass = height < 40 ? 'tiny' : height < 60 ? 'small' : '';
                const bgColor = hexToRgba(event.color, 0.2);
                const textColor = darkenColor(event.color, 0.3);

                return `
                    <div class="event-block ${sizeClass}"
                         data-id="${event.id}"
                         data-day="${day}"
                         style="top: ${top}px; height: ${height}px;
                                background: ${bgColor};
                                border-left-color: ${event.color};
                                color: ${textColor};">
                        <div class="event-title">${event.title}</div>
                        ${event.location ? `<div class="event-location">${event.location}</div>` : ''}
                        <div class="event-time">${formatTime(event.start)} - ${formatTime(event.end)}</div>
                    </div>
                `;
            }).join('');
        }

        function getEventPosition(event) {
            const startMinutes = timeToMinutes(event.start);
            const endMinutes = timeToMinutes(event.end);
            const duration = endMinutes - startMinutes;

            const top = ((startMinutes - state.startHour * 60) / 60) * 60;
            const height = (duration / 60) * 60;

            return { top: Math.max(0, top), height: Math.max(20, height) };
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const displayHour = h % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function darkenColor(hex, amount) {
            const r = Math.max(0, parseInt(hex.slice(1, 3), 16) - 255 * amount);
            const g = Math.max(0, parseInt(hex.slice(3, 5), 16) - 255 * amount);
            const b = Math.max(0, parseInt(hex.slice(5, 7), 16) - 255 * amount);
            return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
        }

        // Modal Functions
        function openEventModal(event = null, day = null, hour = null) {
            state.editingEventId = event ? event.id : null;

            document.getElementById('modalTitle').textContent = event ? 'Edit Event' : 'Add Event';
            document.getElementById('deleteEvent').style.display = event ? 'inline-block' : 'none';
            document.getElementById('copyEvent').style.display = event ? 'inline-block' : 'none';
            document.getElementById('pasteEvent').style.display = (!event && state.copiedEvent) ? 'inline-block' : 'none';

            if (event) {
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventLocation').value = event.location || '';
                document.getElementById('eventDay').value = day;
                document.getElementById('eventStart').value = event.start;
                document.getElementById('eventEnd').value = event.end;
                selectColor(event.color);
            } else {
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventLocation').value = '';
                document.getElementById('eventDay').value = day || state.currentDay;

                if (hour !== null) {
                    const startTime = `${hour.toString().padStart(2, '0')}:00`;
                    const endHour = Math.min(hour + 1, state.endHour);
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    document.getElementById('eventStart').value = startTime;
                    document.getElementById('eventEnd').value = endTime;
                } else {
                    document.getElementById('eventStart').value = '09:00';
                    document.getElementById('eventEnd').value = '10:00';
                }
                selectColor('#4A90A4');
            }

            eventModal.classList.add('active');
            document.getElementById('eventTitle').focus();
        }

        function closeEventModal() {
            eventModal.classList.remove('active');
            state.editingEventId = null;
        }

        function selectColor(color) {
            state.selectedColor = color;
            colorOptions.forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.color === color);
            });
        }

        function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const location = document.getElementById('eventLocation').value.trim();
            const day = document.getElementById('eventDay').value;
            const start = document.getElementById('eventStart').value;
            const end = document.getElementById('eventEnd').value;

            if (!title) {
                alert('Please enter an event title');
                return;
            }

            if (start >= end) {
                alert('End time must be after start time');
                return;
            }

            if (state.editingEventId) {
                // Update existing event
                const eventIndex = state.events[day].findIndex(e => e.id === state.editingEventId);
                if (eventIndex !== -1) {
                    state.events[day][eventIndex] = {
                        ...state.events[day][eventIndex],
                        title,
                        location,
                        start,
                        end,
                        color: state.selectedColor
                    };
                }
            } else {
                // Add new event
                const newEvent = {
                    id: Date.now(),
                    title,
                    location,
                    start,
                    end,
                    color: state.selectedColor
                };
                state.events[day].push(newEvent);
            }

            closeEventModal();
            renderCalendar();
            saveState();
        }

        function deleteEvent() {
            if (!state.editingEventId) return;

            const day = document.getElementById('eventDay').value;
            state.events[day] = state.events[day].filter(e => e.id !== state.editingEventId);

            closeEventModal();
            renderCalendar();
            saveState();
        }

        function copyEvent() {
            const day = document.getElementById('eventDay').value;
            const event = state.events[day].find(e => e.id === state.editingEventId);
            if (event) {
                state.copiedEvent = {
                    title: event.title,
                    location: event.location,
                    start: event.start,
                    end: event.end,
                    color: event.color
                };
                closeEventModal();
                // Show brief feedback
                const btn = document.getElementById('addBtn');
                btn.style.background = '#27ae60';
                setTimeout(() => btn.style.background = '', 500);
            }
        }

        function pasteEvent() {
            if (!state.copiedEvent) return;

            document.getElementById('eventTitle').value = state.copiedEvent.title;
            document.getElementById('eventLocation').value = state.copiedEvent.location || '';
            document.getElementById('eventStart').value = state.copiedEvent.start;
            document.getElementById('eventEnd').value = state.copiedEvent.end;
            selectColor(state.copiedEvent.color);
        }

        function openSettingsModal() {
            document.getElementById('startHour').value = state.startHour;
            document.getElementById('endHour').value = state.endHour;
            document.getElementById('showWeekends').checked = state.showWeekends;
            settingsModal.classList.add('active');
        }

        function closeSettingsModal() {
            settingsModal.classList.remove('active');
        }

        function applySettings() {
            state.startHour = parseInt(document.getElementById('startHour').value);
            state.endHour = parseInt(document.getElementById('endHour').value);
            state.showWeekends = document.getElementById('showWeekends').checked;
            closeSettingsModal();
            renderCalendar();
            saveState();
        }

        function openExportModal() {
            exportModal.classList.add('active');
        }

        function closeExportModal() {
            exportModal.classList.remove('active');
        }

        function openShareModal() {
            const url = encodeScheduleToUrl();
            document.getElementById('shareUrl').value = url;
            document.getElementById('copyStatus').style.display = 'none';
            shareModal.classList.add('active');
        }

        function closeShareModal() {
            shareModal.classList.remove('active');
        }

        function copyShareUrl() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            navigator.clipboard.writeText(urlInput.value).then(() => {
                document.getElementById('copyStatus').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('copyStatus').style.display = 'none';
                }, 2000);
            });
        }

        function resetSchedule() {
            if (!confirm('Reset all events? This cannot be undone.')) return;
            days.forEach(day => state.events[day] = []);
            renderCalendar();
            saveState();
        }

        // Export Functions
        function exportSchedule(format) {
            let allEvents = [];
            days.forEach(day => {
                state.events[day].forEach(event => {
                    allEvents.push({ ...event, day });
                });
            });

            if (allEvents.length === 0) {
                alert('No events to export');
                return;
            }

            allEvents.sort((a, b) => {
                const dayDiff = days.indexOf(a.day) - days.indexOf(b.day);
                if (dayDiff !== 0) return dayDiff;
                return a.start.localeCompare(b.start);
            });

            let content = '';
            let filename = 'schedule';
            let mimeType = '';

            switch (format) {
                case 'csv':
                    content = 'Day,Start,End,Title,Location\n';
                    content += allEvents.map(e =>
                        `${e.day},${e.start},${e.end},"${e.title}","${e.location || ''}"`
                    ).join('\n');
                    filename += '.csv';
                    mimeType = 'text/csv';
                    break;
                case 'json':
                    content = JSON.stringify({ events: allEvents }, null, 2);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                case 'md':
                    content = '# Weekly Schedule\n\n';
                    days.forEach(day => {
                        const dayEvents = allEvents.filter(e => e.day === day);
                        if (dayEvents.length > 0) {
                            const dayIndex = days.indexOf(day);
                            content += `## ${dayNames[dayIndex]}\n\n`;
                            content += '| Time | Event | Location |\n|------|-------|----------|\n';
                            dayEvents.forEach(e => {
                                content += `| ${formatTime(e.start)} - ${formatTime(e.end)} | ${e.title} | ${e.location || '-'} |\n`;
                            });
                            content += '\n';
                        }
                    });
                    filename += '.md';
                    mimeType = 'text/markdown';
                    break;
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            closeExportModal();
        }
    </script>
</body>
</html>
